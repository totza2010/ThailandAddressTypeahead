/**
* @name ThailandAddressTypeahead
* @version 1.0.0
* @update Jan 16, 2024
* @website https://github.com/totza2010/ThailandAddressTypeahead
* @license WTFPL v.2 - http://www.wtfpl.net/
*
* @dependencies: jQuery <https://jquery.com/>
*                typeahead.js <https://github.com/corejavascript/typeahead.js>
**/
class ThailandAddress{constructor(e){this.options=e,this.db=[]}loadData=e=>(this.db=e,this);buildQueryInstance=()=>new Query(this.mapStrings());mapStrings=()=>this.db.flatMap((e=>e.amphure.flatMap((t=>t.tambon.map((i=>({tambon_id:i.id,tambon:i[`name_${this.options.lang}`],tambon_th:i.name_th,tambon_en:i.name_en,amphure_id:t.id,amphure:t[`name_${this.options.lang}`],amphure_th:t.name_th,amphure_en:t.name_en,province_id:e.id,province:e[`name_${this.options.lang}`],province_th:e.name_th,province_en:e.name_en,zipcode:i.zip_code})))))));execute=()=>{const e=this.buildQueryInstance();return $.Address.DB=e,e}}$.Address=e=>{"use strict";e=$.extend({},$.Address.defaults,e);const t=(e,t,i)=>{e=e.toString(),t=t.toString();let s=0,r=0,n=0,a=0;for(let i=0;i<e.length;i++)for(let s=0;t.length>s;s++){let h=0;for(;i+h<e.length&&s+h<t.length&&e.charAt(i+h)===t.charAt(s+h);)h++;h>a&&(a=h,r=i,n=s)}s=Math.max(e.length,t.length);const h=a?a/s:0;return i?Math.floor(100*h):h};!function(t){const i=new ThailandAddress(e);$.getJSON(e.database).done((e=>{t(i.loadData(e).execute())})).fail((t=>{throw new Error(`File "${e.database}" does not exist.`)}))}((i=>{$.Address.DB=i;let s,r,n={empty:" ",suggestion:e=>`<div>${e.tambon} » ${e.amphure} » ${e.province} » ${e.zipcode}</div>`};var a="object"==typeof e.templates?Object.assign(n,e.templates):n;for(let t in e)t.includes("$")&&"$search"!==t&&e.hasOwnProperty(t)&&e[t]&&e[t].typeahead&&e[t].typeahead({hint:!0,highlight:!0,minLength:1},{limit:e.autocomplete_size,templates:a,source:function(e,t){let s=[],r=this.$el.data("field");try{s=i.select("*").where(r).match(`^${e}`).orderBy(r).fetch()}catch(e){}t(s)},display:function(e){return e&&e[this.$el.data("field")]||""}}).parent().find(".tt-dataset").data("field",t.replace("$",""));for(s in e.$search&&e.$search.typeahead({hint:!0,highlight:!0,minLength:2},{limit:e.autocomplete_size,templates:a,source:function(s,r){let n=[];try{n=[...i.select("*").where("zipcode").match(s).fetch(),...i.select("*").where(`province_${e.lang}`).match(s).fetch(),...i.select("*").where(`amphure_${e.lang}`).match(s).fetch(),...i.select("*").where(`tambon_${e.lang}`).match(s).fetch()].map((e=>JSON.stringify(e))).filter(((e,t,i)=>i.indexOf(e)===t)).map((i=>((i=JSON.parse(i)).likely=[5*t(s,i[`tambon_${e.lang}`]),3*t(s,i[`amphure_${e.lang}`].replace(/^เมือง/,"")),t(s,i[`province_${e.lang}`]),t(s,i.zipcode)].reduce(((e,t)=>Math.max(e,t)),0),i))).sort(((e,t)=>t.likely-e.likely))}catch(e){}r(n)},display:()=>""}),e)s.includes("$")&&e.hasOwnProperty(s)&&e[s]&&e[s].bind("typeahead:select typeahead:autocomplete",(function(t,i){for(s in e)r=s.replace("$",""),s.includes("$")&&e.hasOwnProperty(s)&&e[s]&&i[r]&&e[s].typeahead("val",i[r]).trigger("change");"function"==typeof e.onDataFill&&(delete i.likely,e.onDataFill(i))})).blur((function(){this.value||$(this).parent().find(".tt-dataset").html("")}));"function"==typeof e.onLoad&&e.onLoad(),"function"==typeof e.onComplete&&e.onComplete()}))},$.Address.defaults={database:"https://raw.githubusercontent.com/kongvut/thai-province-data/master/api_province_with_amphure_tambon.json",autocomplete_size:20,onLoad:function(){},onDataFill:function(){},$tambon_th:!1,$tambon_en:!1,$tambon_id:!1,$amphure_th:!1,$amphure_en:!1,$amphure_id:!1,$province_th:!1,$province_en:!1,$province_id:!1,$zipcode:!1,$search:!1,lang:"th"},$.Address.setup=e=>$.extend($.Address.defaults,e);class Query{constructor(e){"string"==typeof e&&(e=JSON.parse(e)),this.data_source=e,this.buffer=e,this.focused_field="",this.options=[],this.size=!1;for(let t in e){for(let i in e[t])this.options.push(i);break}}fetch=()=>{if("object"==typeof this.options){let e={};for(let t in this.buffer){e[t]={};for(let i in this.options){let s=this.options[i];this.buffer[t][s]&&(e[t][s]=this.buffer[t][s])}}this.buffer=e}if(this.size){let e=this.size.toString().split(","),t=0,i=this.size;e.length>1&&e[0]<e[1]&&(t=parseInt(e[0]),i=t+parseInt(e[1]));let s={};for(let e=t;i>e&&this.buffer[e];e++)s[e]=this.buffer[e];this.buffer=s}return this.buffer};new=e=>{this.data_source=e,this.buffer=e};limit=e=>(this.size=e,this);select=e=>(this.options=e,"string"==typeof e&&"*"!==e&&(this.options=e.split(",")),this.buffer=this.data_source,this.size=!1,this);where=e=>(this.focused_field=e,this);contains=(e,t)=>{let i=this.buffer;this.buffer=[];for(let s in i)t?~i[s][this.focused_field].indexOf(e)&&this.buffer.push(i[s]):~i[s][this.focused_field].toLowerCase().indexOf(e.toLowerCase())&&this.buffer.push(i[s]);return this};match=(e,t)=>{if("string"==typeof e&&""!==e){t=t||"ig",e=new RegExp(e,t);let i=this.buffer;this.buffer=[];for(let t in i)e.lastIndex=0,e.exec(i[t][this.focused_field])&&this.buffer.push(i[t])}return this};equalTo=e=>{let t=this.buffer;this.buffer=[];for(let i in t)t[i][this.focused_field]==e&&this.buffer.push(t[i]);return this};whereIn=e=>{let t=this.buffer;this.buffer=[];for(let i in t)this.in_array(t[i][this.focused_field],e)&&this.buffer.push(t[i]);return this};moreThan=e=>{let t=this.buffer;this.buffer=[];for(let i in t)parseFloat(t[i][this.focused_field])>parseFloat(e)&&this.buffer.push(t[i]);return this};moreThanOrEqualTo=e=>{let t=this.buffer;this.buffer=[];for(let i in t)parseFloat(t[i][this.focused_field])>=parseFloat(e)&&this.buffer.push(t[i]);return this};lessThan=e=>{let t=this.buffer;this.buffer=[];for(let i in t)parseFloat(t[i][this.focused_field])<parseFloat(e)&&this.buffer.push(t[i]);return this};lessThanOrEqualTo=e=>{let t=this.buffer;this.buffer=[];for(let i in t)parseFloat(t[i][this.focused_field])<=parseFloat(e)&&this.buffer.push(t[i]);return this};orderBy=(e,t)=>{let i="asc",s=e.split(" "),r=s.pop();r&&"desc"==r.toLowerCase()&&(i="desc",e=s.join(" "));let n=[];for(let t in this.buffer)n.push([t,this.buffer[t][e]]);if(n.length<2)return this;"string"==(t=null==t&&isNaN(n[0][1])?"string":"numeric")?n.sort(((e,t)=>e[1]<t[1]?-1:e[1]>t[1]?1:0)):n.sort(((e,t)=>e[1]-t[1]));let a=[];for(let e in n)a.push(this.buffer[n[e][0]]);return this.buffer=a,"desc"==i&&(this.buffer=this.buffer.reverse()),this};and=this.where;is=this.equalTo;in_array=(e,t)=>{for(let i in t)if(e==t[i])return!0;return!1}}